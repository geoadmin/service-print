user nginx;

# should be equal to the number of process on the host machine
worker_processes 8;

error_log /dev/stdout info;


events {
  worker_connections 10000;
  accept_mutex on;
}

http {
  default_type text/plain;
  # if we use analytics we may want to turn that off
  access_log off;
  sendfile off;
  # this removes the "host_header" related issue
  underscores_in_headers on;


  # Apache/Nginx                                   WSGI                            Tomcat
  #
  # GET  /print/info.json                                                        GET /service-print-main/pdf/info.json
  # 
  # POST /print/create.json                                                      POST /service-print-main/pdf/create.json
  # 
 # POST /printmulti/create.json             POST /printmulti/create.json
  # 
  # GET  /printprogress?id=232323            GET /printprogress?id=232323
  # 
  # GET  /printcancel                        GET /printcancel
  # 
  # GET /print/-multi23444545.pdf.printout
  # GET /print/9032936254995330149.pdf.printout
  # static to /var/local/print/mapfish-print9032936254995330149.pdf.printout

  # proxying tomcat
  server {
    listen ${NGINX_PORT};
    #server_name service-print.${PRINT_ENV}.bgdi.ch;

    root /var/local/print;

    location ~ /[0-9]+/print/ {
      #rewrite ^/[0-9]+/print/(.*) /service-print-main/pdf/$1 break;
      rewrite ^/[0-9]+/print/(.*) /print/$1;
      #alias /print/;
      # Do not cache anything
      #expires off;
      
      #proxy_pass http://localhost:${TOMCAT_PORT};
    }
    # PDF download
    location ~  [0-9]+\.pdf\.printout$ {
      # Do not cache anything
      expires off;

      rewrite ^/print(proxy)?/(\-multi)?([0-9]+\.pdf\.printout)$ /mapfish-print$2$3 last;
      add_header Content-Disposition "attachment; filename=map.geo.admin.ch.pdf";
    }

    location  /print/ {
      add_header 'Access-Control-Allow-Origin' '*' always;
      add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
      add_header 'Access-Control-Allow-Headers' 'Accept,Authorization,Cache-Control,Content-Type,DNT,If-Modified-Since,Keep-Alive,Origin,User-Agent,X-Requested-With' always;

      # Do not cache anything
      expires off;
      
      proxy_pass http://localhost:${TOMCAT_PORT}/service-print-main/pdf/;
    }
    # For migration
    location /service-print-main/ {
      # Do not cache anything
      expires off;
      
      proxy_pass http://localhost:${TOMCAT_PORT}/service-print-main/;
    }

    # proxying wsgi

    location  /printmulti/ {
      add_header 'Access-Control-Allow-Origin' '*' always;
      add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
      add_header 'Access-Control-Allow-Headers' 'Accept,Authorization,Cache-Control,Content-Type,DNT,If-Modified-Since,Keep-Alive,Origin,User-Agent,X-Requested-With' always;
      # Do not cache anything
      expires off;
      
      proxy_pass http://localhost:${WSGI_PORT}/printmulti/;
    }
    location  /printprogress {
      # Do not cache anything
      expires off;
      
      proxy_pass http://localhost:${WSGI_PORT}/printprogress;
    }
    location  /printcancel {
      # Do not cache anything
      expires off;
      
      proxy_pass http://localhost:${WSGI_PORT}/printcancel;
    }


    location /nginx-status {
      # Turn on nginx stats
      stub_status on;

      # I do not need logs for stats
      access_log   off;

      # Allow access from localhost
      allow 127.0.0.1;
      # Security: Only allow access from vpc #
      allow 10.220.0.0/21;
      # Send rest of the world to /dev/null #
      deny all;
    }
    
    location /checker {
      access_log   off;
      add_header Content-Type text/plain;
      return 200 'OK';
    }
    location /tomcat_checker {
      expires off;
      proxy_pass http://localhost:${TOMCAT_PORT}/service-print-main/checker;
    }
    location /wsgi_checker {
      expires off;
      proxy_pass http://localhost:${WSGI_PORT}/checker;
    }
    location /backend_checker {
      expires off;
      proxy_pass http://localhost:${WSGI_PORT}/backend_checker;
    }
  }
}
