user nginx;

# should be equal to the number of process on the host machine
worker_processes 8;

error_log /dev/stdout info;


events {
  worker_connections 10000;
  accept_mutex on;
}

http {
  default_type text/plain;
  # if we use analytics we may want to turn that off
  access_log off;
  sendfile off;
  # this removes the "host_header" related issue
  underscores_in_headers on;


  # Apache/Nginx                                   WSGI                            Tomcat
  #
  # GET  /print/info.json                                                        GET /service-print-main/pdf/info.json
  # 
  # POST /print/create.json                                                      POST /service-print-main/pdf/create.json
  # 
  # POST /multiprint/create.json             POST /multiprint/create.json
  # 
  # GET  /printprogress?id=232323            GET /printprogress?id=232323
  # 
  # GET  /printcancel                        GET /printcancel
  # 
  # GET /print/-multi23444545.pdf.printout
  # static to /var/local/print

  # proxying tomcat
  server {
    listen ${NGINX_PORT};
    server_name service-print.${PRINT_ENV}.bgdi.ch;
    location /print/ {
      # Do not cache anything
      expires off;
      
      proxy_pass http://localhost:${TOMCAT_PORT}/service-print-main/pdf/;
    }
    # For migration
    location /service-print-main/ {
      # Do not cache anything
      expires off;
      
      proxy_pass http://localhost:${TOMCAT_PORT}/service-print-main/;
    }
  }
  # proxying wsgi
  server {
    listen ${NGINX_PORT};
    server_name service-print.${PRINT_ENV}.bgdi.ch;
    location  /multiprint {
      # Do not cache anything
      expires off;
      
      proxy_pass http://localhost:${WSGI_PORT};
    }
    location  /printprogress {
      # Do not cache anything
      expires off;
      
      proxy_pass http://localhost:${WSGI_PORT};
    }
    location  /printcancel {
      # Do not cache anything
      expires off;
      
      proxy_pass http://localhost:${WSGI_PORT};
    }
  }
  # static pdf
  server {
    listen ${NGINX_PORT};
    server_name service-print.${PRINT_ENV}.bgdi.ch;
    root /var/local/print;

    location ~  [0-9]+\.pdf\.printout$ {
      # Do not cache anything
      expires off;

      rewrite ^/print(proxy)?/(\-multi)?([0-9]+\.pdf\.printout)$ /mapfish-print$2$3 last;
      add_header Content-Disposition "attachment; filename=map.geo.admin.ch.pdf";
      
    }
  }

  server {
    listen ${NGINX_PORT} default_server;
    location /nginx-status {
      # Turn on nginx stats
      stub_status on;

      # I do not need logs for stats
      access_log   off;

      # Allow access from localhost
      allow 127.0.0.1;
      # Security: Only allow access from vpc #
      allow 10.220.0.0/21;
      # Send rest of the world to /dev/null #
      deny all;
    }
    
    location /checker {
      access_log   off;
      add_header Content-Type text/plain;
      return 200 'OK';
    }
    location /tomcat_checker {
      expires off;
      proxy_pass http://localhost:${TOMCAT_PORT}/service-print-main/checker;
    }
    location /wsgi_checker {
      expires off;
      proxy_pass http://localhost:${WSGI_PORT}/checker;
    }
    location /backend_checker {
      expires off;
      proxy_pass http://localhost:${WSGI_PORT}/backend_checker;
    }
  }
}
